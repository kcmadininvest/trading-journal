# ============================================================================
# TEMPLATE DE CONFIGURATION APACHE - Trading Journal
# ============================================================================
# 
# ⚠️  ATTENTION: Ce fichier est un TEMPLATE/EXEMPLE
# 
# Ce fichier contient une configuration Apache de référence basée sur la
# configuration de production avec:
# - Headers de sécurité complets (HSTS, CSP, X-Frame-Options, etc.)
# - Protection contre TRACE/TRACK, clickjacking, XSS
# - Configuration proxy pour Django (Daphne ASGI) et React
# - Configuration SSL/HTTPS avec Let's Encrypt
# - Gestion SPA React avec fallback vers index.html
# - Support SSR/pré-rendering
# - Redirection SEO pour paramètres ?lang=
# - Alias pour fichiers statiques et média
# 
# UTILISATION:
# 1. Copiez ce fichier vers /etc/httpd/conf.d/trading-journal.conf
# 2. Personnalisez les valeurs suivantes:
#    - ServerName: votre domaine réel (ex: app.example.com)
#    - SSLCertificateFile: chemin vers votre certificat SSL Let's Encrypt
#    - SSLCertificateKeyFile: chemin vers votre clé privée Let's Encrypt
#    - Fichier Google Search Console: googleXXXXXXXXXXXXXX.html
#    - PROJECT_ROOT: chemin vers votre projet (par défaut: /var/www/html/trading_journal)
#    - Port Daphne: 8001 (déjà configuré)
# 
# Ce fichier est versionné dans Git comme référence/documentation.
# Ne l'utilisez PAS directement en production sans personnalisation.
# ============================================================================

# Sécurité globale
ServerTokens Prod
ServerSignature Off
TraceEnable Off

# --- HTTP VirtualHost (redirection vers HTTPS) ---
<VirtualHost *:80>
    ServerName your-domain.com
    DocumentRoot /var/www/html/trading_journal/frontend/build

    # Augmenter les timeouts pour les requêtes longues
    Timeout 300
    ProxyTimeout 300

    # Configuration proxy pour headers X-Forwarded (nécessaire pour Django)
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"
    RequestHeader unset X-Forwarded-For
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e"

    # --- Backend Django/DRF via ProxyPass vers Daphne ASGI (port 8001) ---
    ProxyPass /api/ http://127.0.0.1:8001/api/
    ProxyPassReverse /api/ http://127.0.0.1:8001/api/

    # Proxy pour admin Django
    ProxyPass /admin/ http://127.0.0.1:8001/admin/
    ProxyPassReverse /admin/ http://127.0.0.1:8001/admin/

    # Proxy pour sitemap et autres routes Django
    ProxyPass /sitemap.xml http://127.0.0.1:8001/sitemap.xml
    ProxyPassReverse /sitemap.xml http://127.0.0.1:8001/sitemap.xml

    ProxyPass /schema/ http://127.0.0.1:8001/schema/
    ProxyPassReverse /schema/ http://127.0.0.1:8001/schema/

    # Proxy pour les fichiers spéciaux gérés par Django
    ProxyPass /favicon.ico http://127.0.0.1:8001/favicon.ico
    ProxyPassReverse /favicon.ico http://127.0.0.1:8001/favicon.ico

    # --- Protection du répertoire docs (documentation technique) ---
    <LocationMatch "^/docs/">
        Require all denied
    </LocationMatch>

    # --- Fichiers React (favicon, manifest, logos) ---
    Alias /favicon.ico /var/www/html/trading_journal/frontend/build/favicon.ico
    Alias /favicon.svg /var/www/html/trading_journal/frontend/build/favicon.svg
    Alias /manifest.json /var/www/html/trading_journal/frontend/build/manifest.json
    Alias /logo192.png /var/www/html/trading_journal/frontend/build/logo192.png
    Alias /logo512.png /var/www/html/trading_journal/frontend/build/logo512.png
    # Fichier de vérification Google Search Console (personnaliser avec votre ID)
    Alias /googleXXXXXXXXXXXXXX.html /var/www/html/trading_journal/frontend/build/googleXXXXXXXXXXXXXX.html

    # --- Statics React ---
    Alias /static/ /var/www/html/trading_journal/frontend/build/static/
    <Directory /var/www/html/trading_journal/frontend/build/static>
        Require all granted
    </Directory>

    # --- Statics Django ---
    Alias /static/ /var/www/html/trading_journal/backend/static/
    <Directory /var/www/html/trading_journal/backend/static>
        Require all granted
    </Directory>

    # --- Media Django ---
    Alias /media/ /var/www/html/trading_journal/backend/media/
    <Directory /var/www/html/trading_journal/backend/media>
        Require all granted
    </Directory>

    # --- Frontend SPA (React) avec support SSR/Pré-rendering ---
    <Directory /var/www/html/trading_journal/frontend/build>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        RewriteEngine On
        RewriteBase /

        # Redirection 301 pour supprimer les paramètres ?lang= (SEO fix)
        # Redirige https://your-domain.com/?lang=en vers https://your-domain.com/
        RewriteCond %{QUERY_STRING} ^lang=(fr|en|es|de)$ [NC]
        RewriteRule ^$ /? [R=301,L]

        # Servir fichiers existants
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]

        # Exception pour les fichiers de vérification Google Search Console
        RewriteCond %{REQUEST_URI} ^/google[a-z0-9]+\.html$ [NC]
        RewriteRule ^ - [L]

        # Exception pour le sitemap.xml (géré par Django)
        RewriteCond %{REQUEST_URI} ^/sitemap\.xml$ [NC]
        RewriteRule ^ - [L]

        # Ne pas intercepter l'API
        RewriteCond %{REQUEST_URI} !^/api/ [NC]
        # Ne pas intercepter admin
        RewriteCond %{REQUEST_URI} !^/admin/ [NC]
        
        # SSR/Pré-rendering : servir les pages pré-rendues si présentes
        RewriteCond %{QUERY_STRING} ^lang=(fr|en|es|de)$ [NC]
        RewriteCond %{DOCUMENT_ROOT}/prerendered/index.%1.html -f
        RewriteRule ^$ /prerendered/index.%1.html [L]
        
        RewriteCond %{DOCUMENT_ROOT}/prerendered%{REQUEST_URI}/index.html -f
        RewriteRule ^(.*)$ /prerendered%{REQUEST_URI}/index.html [L]
        
        # Fallback vers index.html standard (SPA)
        RewriteRule ^ index.html [L]
    </Directory>

    # Redirection vers HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    ErrorLog  /var/log/httpd/trading_journal_app_error.log
    CustomLog /var/log/httpd/trading_journal_app_access.log combined
</VirtualHost>

# --- HTTPS VirtualHost ---
<VirtualHost *:443>
    ServerName your-domain.com
    DocumentRoot /var/www/html/trading_journal/frontend/build

    # Configuration SSL (Let's Encrypt)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/your-domain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/your-domain.com/privkey.pem

    # Augmenter les timeouts pour les requêtes longues
    Timeout 300
    ProxyTimeout 300

    # Configuration proxy pour headers X-Forwarded (nécessaire pour Django)
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader unset X-Forwarded-For
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e"

    # --- Backend Django/DRF via ProxyPass vers Daphne ASGI (port 8001) ---
    ProxyPass /api/ http://127.0.0.1:8001/api/
    ProxyPassReverse /api/ http://127.0.0.1:8001/api/

    # Proxy pour admin Django
    ProxyPass /admin/ http://127.0.0.1:8001/admin/
    ProxyPassReverse /admin/ http://127.0.0.1:8001/admin/

    # Proxy pour sitemap et autres routes Django
    ProxyPass /sitemap.xml http://127.0.0.1:8001/sitemap.xml
    ProxyPassReverse /sitemap.xml http://127.0.0.1:8001/sitemap.xml

    ProxyPass /schema/ http://127.0.0.1:8001/schema/
    ProxyPassReverse /schema/ http://127.0.0.1:8001/schema/

    # Proxy pour les fichiers spéciaux gérés par Django
    ProxyPass /favicon.ico http://127.0.0.1:8001/favicon.ico
    ProxyPassReverse /favicon.ico http://127.0.0.1:8001/favicon.ico

    # --- Protection du répertoire docs (documentation technique) ---
    <LocationMatch "^/docs/">
        Require all denied
    </LocationMatch>

    # --- Fichiers React (favicon, manifest, logos) ---
    Alias /favicon.ico /var/www/html/trading_journal/frontend/build/favicon.ico
    Alias /favicon.svg /var/www/html/trading_journal/frontend/build/favicon.svg
    Alias /manifest.json /var/www/html/trading_journal/frontend/build/manifest.json
    Alias /logo192.png /var/www/html/trading_journal/frontend/build/logo192.png
    Alias /logo512.png /var/www/html/trading_journal/frontend/build/logo512.png
    # Fichier de vérification Google Search Console (personnaliser avec votre ID)
    Alias /googleXXXXXXXXXXXXXX.html /var/www/html/trading_journal/frontend/build/googleXXXXXXXXXXXXXX.html

    # --- Statics React ---
    Alias /static/ /var/www/html/trading_journal/frontend/build/static/
    <Directory /var/www/html/trading_journal/frontend/build/static>
        Require all granted
    </Directory>

    # --- Statics Django ---
    Alias /static/ /var/www/html/trading_journal/backend/static/
    <Directory /var/www/html/trading_journal/backend/static>
        Require all granted
    </Directory>

    # --- Media Django ---
    Alias /media/ /var/www/html/trading_journal/backend/media/
    <Directory /var/www/html/trading_journal/backend/media>
        Require all granted
    </Directory>

    # --- Frontend SPA (React) avec support SSR/Pré-rendering ---
    <Directory /var/www/html/trading_journal/frontend/build>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        RewriteEngine On
        RewriteBase /

        # Redirection 301 pour supprimer les paramètres ?lang= (SEO fix)
        # Redirige https://your-domain.com/?lang=en vers https://your-domain.com/
        RewriteCond %{QUERY_STRING} ^lang=(fr|en|es|de)$ [NC]
        RewriteRule ^$ /? [R=301,L]

        # Servir fichiers existants
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]

        # Exception pour les fichiers de vérification Google Search Console
        RewriteCond %{REQUEST_URI} ^/google[a-z0-9]+\.html$ [NC]
        RewriteRule ^ - [L]

        # Exception pour le sitemap.xml (géré par Django)
        RewriteCond %{REQUEST_URI} ^/sitemap\.xml$ [NC]
        RewriteRule ^ - [L]

        # Ne pas intercepter l'API
        RewriteCond %{REQUEST_URI} !^/api/ [NC]
        # Ne pas intercepter admin
        RewriteCond %{REQUEST_URI} !^/admin/ [NC]
        
        # SSR/Pré-rendering : servir les pages pré-rendues si présentes
        RewriteCond %{QUERY_STRING} ^lang=(fr|en|es|de)$ [NC]
        RewriteCond %{DOCUMENT_ROOT}/prerendered/index.%1.html -f
        RewriteRule ^$ /prerendered/index.%1.html [L]
        
        RewriteCond %{DOCUMENT_ROOT}/prerendered%{REQUEST_URI}/index.html -f
        RewriteRule ^(.*)$ /prerendered%{REQUEST_URI}/index.html [L]
        
        # Fallback vers index.html standard (SPA)
        RewriteRule ^ index.html [L]
    </Directory>

    # ========================================================================
    # HEADERS DE SÉCURITÉ - Configuration renforcée selon scan de sécurité
    # ========================================================================
    
    # HSTS - Force HTTPS pour 1 an (incluant sous-domaines)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Protection contre le clickjacking
    Header always set X-Frame-Options "DENY"
    
    # Prévention du MIME sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Politique de référent
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Protection XSS (legacy browsers)
    Header always set X-XSS-Protection "1; mode=block"
    
    # Content Security Policy - Sans wildcards pour éviter les vulnérabilités
    # Ajusté pour permettre les CDNs nécessaires tout en restant sécurisé
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests"

    # Laisser CORS à Django/DRF
    Header unset Access-Control-Allow-Origin
    Header unset Access-Control-Allow-Methods
    Header unset Access-Control-Allow-Headers
    Header unset Access-Control-Allow-Credentials
    Header unset Vary

    ErrorLog  /var/log/httpd/trading_journal_app_error.log
    CustomLog /var/log/httpd/trading_journal_app_access.log combined
</VirtualHost>
