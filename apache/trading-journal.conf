# Configuration httpd (Apache) pour Trading Journal
# Placez ce fichier dans /etc/httpd/conf.d/ sur votre serveur AlmaLinux 9

<VirtualHost *:80>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    
    # Redirection vers HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    
    # Configuration SSL
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    SSLCertificateChainFile /path/to/your/chain.crt
    
    # Headers de sécurité
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Bloquer l'accès au répertoire docs (documentation technique)
    <LocationMatch "^/docs/">
        Require all denied
    </LocationMatch>
    
    # Proxy vers le frontend React (port 3000)
    ProxyPreserveHost On
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    # Proxy vers l'API Django (port 8000)
    ProxyPass /api/ http://localhost:8000/api/
    ProxyPassReverse /api/ http://localhost:8000/api/
    
    # Proxy pour les fichiers statiques Django
    ProxyPass /static/ http://localhost:8000/static/
    ProxyPassReverse /static/ http://localhost:8000/static/
    
    # Proxy pour les fichiers média Django
    ProxyPass /media/ http://localhost:8000/media/
    ProxyPassReverse /media/ http://localhost:8000/media/
    
    # Configuration des timeouts
    ProxyTimeout 300
    
    # Logs
    ErrorLog /var/log/httpd/trading-journal_error.log
    CustomLog /var/log/httpd/trading-journal_access.log combined
    
    # Configuration pour les WebSockets (si nécessaire)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/ws/(.*)$ "ws://localhost:8000/ws/$1" [P,L]
</VirtualHost>

# Configuration alternative sans SSL (pour les tests)
<VirtualHost *:80>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    
    # Headers de sécurité
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Proxy vers le frontend React (port 3000)
    ProxyPreserveHost On
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    # Proxy vers l'API Django (port 8000)
    ProxyPass /api/ http://localhost:8000/api/
    ProxyPassReverse /api/ http://localhost:8000/api/
    
    # Proxy pour les fichiers statiques Django
    ProxyPass /static/ http://localhost:8000/static/
    ProxyPassReverse /static/ http://localhost:8000/static/
    
    # Proxy pour les fichiers média Django
    ProxyPass /media/ http://localhost:8000/media/
    ProxyPassReverse /media/ http://localhost:8000/media/
    
    # Configuration des timeouts
    ProxyTimeout 300
    
    # Logs
    ErrorLog /var/log/httpd/trading-journal_error.log
    CustomLog /var/log/httpd/trading-journal_access.log combined
</VirtualHost>
