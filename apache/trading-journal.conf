# ============================================================================
# TEMPLATE DE CONFIGURATION APACHE - Trading Journal
# ============================================================================
# 
# ⚠️  ATTENTION: Ce fichier est un TEMPLATE/EXEMPLE
# 
# Ce fichier contient une configuration Apache de référence basée sur la
# configuration de production avec:
# - Headers de sécurité complets
# - Configuration proxy pour Django (Daphne ASGI) et React
# - Configuration SSL/HTTPS avec Let's Encrypt
# - Gestion SPA React avec fallback vers index.html
# - Alias pour fichiers statiques et média
# 
# UTILISATION:
# 1. Copiez ce fichier vers /etc/httpd/conf.d/trading-journal.conf
# 2. Personnalisez les valeurs suivantes:
#    - ServerName: votre domaine réel (ex: app.kctradingjournal.com)
#    - SSLCertificateFile: chemin vers votre certificat SSL Let's Encrypt
#    - SSLCertificateKeyFile: chemin vers votre clé privée Let's Encrypt
#    - PROJECT_ROOT: chemin vers votre projet (par défaut: /var/www/html/trading_journal)
#    - Port Daphne: 8001 (déjà configuré)
# 
# Ce fichier est versionné dans Git comme référence/documentation.
# Ne l'utilisez PAS directement en production sans personnalisation.
# ============================================================================

# Sécurité globale
ServerTokens Prod
ServerSignature Off

# --- HTTP VirtualHost (redirection vers HTTPS) ---
<VirtualHost *:80>
    ServerName your-domain.com
    DocumentRoot /var/www/html/trading_journal/frontend/build

    # Augmenter les timeouts pour les requêtes longues
    Timeout 300
    ProxyTimeout 300

    # Configuration proxy pour headers X-Forwarded (nécessaire pour Django)
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"
    RequestHeader unset X-Forwarded-For
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e"

    # --- Backend Django/DRF via ProxyPass vers Daphne ASGI (port 8001) ---
    ProxyPass /api/ http://127.0.0.1:8001/api/
    ProxyPassReverse /api/ http://127.0.0.1:8001/api/

    # Proxy pour admin Django
    ProxyPass /admin/ http://127.0.0.1:8001/admin/
    ProxyPassReverse /admin/ http://127.0.0.1:8001/admin/

    # Proxy pour sitemap et autres routes Django
    ProxyPass /sitemap.xml http://127.0.0.1:8001/sitemap.xml
    ProxyPassReverse /sitemap.xml http://127.0.0.1:8001/sitemap.xml

    ProxyPass /schema/ http://127.0.0.1:8001/schema/
    ProxyPassReverse /schema/ http://127.0.0.1:8001/schema/

    # Proxy pour les fichiers spéciaux gérés par Django
    ProxyPass /favicon.ico http://127.0.0.1:8001/favicon.ico
    ProxyPassReverse /favicon.ico http://127.0.0.1:8001/favicon.ico

    # --- Protection du répertoire docs (documentation technique) ---
    <LocationMatch "^/docs/">
        Require all denied
    </LocationMatch>

    # --- Fichiers React (favicon, manifest, logos) ---
    Alias /favicon.ico /var/www/html/trading_journal/frontend/build/favicon.ico
    Alias /favicon.svg /var/www/html/trading_journal/frontend/build/favicon.svg
    Alias /manifest.json /var/www/html/trading_journal/frontend/build/manifest.json
    Alias /logo192.png /var/www/html/trading_journal/frontend/build/logo192.png
    Alias /logo512.png /var/www/html/trading_journal/frontend/build/logo512.png
    # Fichier de vérification Google Search Console (ajuster le nom si nécessaire)
    # Exemple: Alias /googleXXXXXXXXXXXXXX.html /var/www/html/trading_journal/frontend/build/googleXXXXXXXXXXXXXX.html

    # --- Statics React ---
    Alias /static/ /var/www/html/trading_journal/frontend/build/static/
    <Directory /var/www/html/trading_journal/frontend/build/static>
        Require all granted
    </Directory>

    # --- Statics Django ---
    Alias /static/ /var/www/html/trading_journal/backend/static/
    <Directory /var/www/html/trading_journal/backend/static>
        Require all granted
    </Directory>

    # --- Media Django ---
    Alias /media/ /var/www/html/trading_journal/backend/media/
    <Directory /var/www/html/trading_journal/backend/media>
        Require all granted
    </Directory>

    # --- Frontend SPA (React) avec support SSR/Pré-rendering ---
    <Directory /var/www/html/trading_journal/frontend/build>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        RewriteEngine On
        RewriteBase /

        # Servir fichiers existants
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]

        # Exception pour les fichiers de vérification Google Search Console
        RewriteCond %{REQUEST_URI} ^/google[a-z0-9]+\.html$ [NC]
        RewriteRule ^ - [L]

        # Exception pour le sitemap.xml (géré par Django)
        RewriteCond %{REQUEST_URI} ^/sitemap\.xml$ [NC]
        RewriteRule ^ - [L]

        # Ne pas intercepter l'API
        RewriteCond %{REQUEST_URI} !^/api/ [NC]
        # Ne pas intercepter admin
        RewriteCond %{REQUEST_URI} !^/admin/ [NC]
        
        # SSR/Pré-rendering : Servir les pages pré-rendues si elles existent
        # Pour la page d'accueil avec paramètre lang
        RewriteCond %{QUERY_STRING} ^lang=(fr|en|es|de)$ [NC]
        RewriteCond %{DOCUMENT_ROOT}/prerendered/index.%1.html -f
        RewriteRule ^$ /prerendered/index.%1.html [L]
        
        # Pour les pages avec chemins spécifiques (about, features, etc.)
        # Vérifier si une page pré-rendue existe pour ce chemin
        RewriteCond %{DOCUMENT_ROOT}/prerendered%{REQUEST_URI}/index.html -f
        RewriteRule ^(.*)$ /prerendered%{REQUEST_URI}/index.html [L]
        
        # Fallback vers index.html standard (SPA)
        RewriteRule ^ index.html [L]
    </Directory>

    # Redirection vers HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    ErrorLog  /var/log/httpd/trading_journal_app_error.log
    CustomLog /var/log/httpd/trading_journal_app_access.log combined
</VirtualHost>

# --- HTTPS VirtualHost ---
<VirtualHost *:443>
    ServerName your-domain.com
    DocumentRoot /var/www/html/trading_journal/frontend/build

    # Configuration SSL (Let's Encrypt)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/your-domain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/your-domain.com/privkey.pem

    # Augmenter les timeouts pour les requêtes longues
    Timeout 300
    ProxyTimeout 300

    # Configuration proxy pour headers X-Forwarded (nécessaire pour Django)
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader unset X-Forwarded-For
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e"

    # --- Backend Django/DRF via ProxyPass vers Daphne ASGI (port 8001) ---
    ProxyPass /api/ http://127.0.0.1:8001/api/
    ProxyPassReverse /api/ http://127.0.0.1:8001/api/

    # Proxy pour admin Django
    ProxyPass /admin/ http://127.0.0.1:8001/admin/
    ProxyPassReverse /admin/ http://127.0.0.1:8001/admin/

    # Proxy pour sitemap et autres routes Django
    ProxyPass /sitemap.xml http://127.0.0.1:8001/sitemap.xml
    ProxyPassReverse /sitemap.xml http://127.0.0.1:8001/sitemap.xml

    ProxyPass /schema/ http://127.0.0.1:8001/schema/
    ProxyPassReverse /schema/ http://127.0.0.1:8001/schema/

    # Proxy pour les fichiers spéciaux gérés par Django
    ProxyPass /favicon.ico http://127.0.0.1:8001/favicon.ico
    ProxyPassReverse /favicon.ico http://127.0.0.1:8001/favicon.ico

    # --- Protection du répertoire docs (documentation technique) ---
    <LocationMatch "^/docs/">
        Require all denied
    </LocationMatch>

    # --- Fichiers React (favicon, manifest, logos) ---
    Alias /favicon.ico /var/www/html/trading_journal/frontend/build/favicon.ico
    Alias /favicon.svg /var/www/html/trading_journal/frontend/build/favicon.svg
    Alias /manifest.json /var/www/html/trading_journal/frontend/build/manifest.json
    Alias /logo192.png /var/www/html/trading_journal/frontend/build/logo192.png
    Alias /logo512.png /var/www/html/trading_journal/frontend/build/logo512.png
    # Fichier de vérification Google Search Console (ajuster le nom si nécessaire)
    # Exemple: Alias /googleXXXXXXXXXXXXXX.html /var/www/html/trading_journal/frontend/build/googleXXXXXXXXXXXXXX.html

    # --- Statics React ---
    Alias /static/ /var/www/html/trading_journal/frontend/build/static/
    <Directory /var/www/html/trading_journal/frontend/build/static>
        Require all granted
    </Directory>

    # --- Statics Django ---
    Alias /static/ /var/www/html/trading_journal/backend/static/
    <Directory /var/www/html/trading_journal/backend/static>
        Require all granted
    </Directory>

    # --- Media Django ---
    Alias /media/ /var/www/html/trading_journal/backend/media/
    <Directory /var/www/html/trading_journal/backend/media>
        Require all granted
    </Directory>

    # --- Frontend SPA (React) avec support SSR/Pré-rendering ---
    <Directory /var/www/html/trading_journal/frontend/build>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        RewriteEngine On
        RewriteBase /

        # Servir fichiers existants
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]

        # Exception pour les fichiers de vérification Google Search Console
        RewriteCond %{REQUEST_URI} ^/google[a-z0-9]+\.html$ [NC]
        RewriteRule ^ - [L]

        # Exception pour le sitemap.xml (géré par Django)
        RewriteCond %{REQUEST_URI} ^/sitemap\.xml$ [NC]
        RewriteRule ^ - [L]

        # Ne pas intercepter l'API
        RewriteCond %{REQUEST_URI} !^/api/ [NC]
        # Ne pas intercepter admin
        RewriteCond %{REQUEST_URI} !^/admin/ [NC]
        
        # SSR/Pré-rendering : Servir les pages pré-rendues si elles existent
        # Pour la page d'accueil avec paramètre lang
        RewriteCond %{QUERY_STRING} ^lang=(fr|en|es|de)$ [NC]
        RewriteCond %{DOCUMENT_ROOT}/prerendered/index.%1.html -f
        RewriteRule ^$ /prerendered/index.%1.html [L]
        
        # Pour les pages avec chemins spécifiques (about, features, etc.)
        # Vérifier si une page pré-rendue existe pour ce chemin
        RewriteCond %{DOCUMENT_ROOT}/prerendered%{REQUEST_URI}/index.html -f
        RewriteRule ^(.*)$ /prerendered%{REQUEST_URI}/index.html [L]
        
        # Fallback vers index.html standard (SPA)
        RewriteRule ^ index.html [L]
    </Directory>

    # Headers de sécurité - HSTS uniquement
    # Les autres headers (CSP, X-Frame-Options, etc.) sont gérés par Django
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Supprimer les headers de sécurité dupliqués qui sont gérés par Django
    Header unset X-Frame-Options
    Header unset Content-Security-Policy
    Header unset X-Content-Type-Options
    Header unset Referrer-Policy

    # Laisser CORS à Django/DRF
    Header unset Access-Control-Allow-Origin
    Header unset Access-Control-Allow-Methods
    Header unset Access-Control-Allow-Headers
    Header unset Access-Control-Allow-Credentials
    Header unset Vary

    ErrorLog  /var/log/httpd/trading_journal_app_error.log
    CustomLog /var/log/httpd/trading_journal_app_access.log combined
</VirtualHost>
